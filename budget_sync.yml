name: ğŸ“Š ì•„ì‚°ì‹œ ì˜ˆì‚° ë°ì´í„° ìë™ ë™ê¸°í™”

on:
  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) ìë™ ì‹¤í–‰ = UTC 00:00
  schedule:
    - cron: '0 0 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'ë™ê¸°í™” ìœ í˜•'
        required: true
        default: 'full'
        type: choice
        options:
          - full      # ì „ì²´ ë™ê¸°í™” (Sheets â†’ Notion â†’ Dashboard)
          - sheets    # Sheets â†’ Notionë§Œ
          - dashboard # Notion â†’ Dashboardë§Œ

  # Slack webhook íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [budget-update]

  # ì½”ë“œ ë³€ê²½ ì‹œ (main ë¸Œëœì¹˜)
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - '.github/workflows/budget_sync.yml'

env:
  NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
  GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
  GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # ============================================
  # Job 1: Google Sheets â†’ Notion ë™ê¸°í™”
  # ============================================
  sync-sheets-to-notion:
    runs-on: ubuntu-latest
    name: ğŸ“¥ Sheets â†’ Notion
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_type != 'dashboard')
    
    outputs:
      updated: ${{ steps.sync.outputs.updated }}
      created: ${{ steps.sync.outputs.created }}
      errors: ${{ steps.sync.outputs.errors }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install requests gspread google-auth

      - name: ğŸ”„ ì˜ˆì‚° ë°ì´í„° ë™ê¸°í™”
        id: sync
        run: |
          python scripts/sync_budget_to_notion.py 2>&1 | tee sync_log.txt
          # ê²°ê³¼ íŒŒì‹± (ë¡œê·¸ì—ì„œ ì¶”ì¶œ)
          updated=$(grep -oP 'ì—…ë°ì´íŠ¸: \K\d+' sync_log.txt || echo "0")
          created=$(grep -oP 'ì‹ ê·œìƒì„±: \K\d+' sync_log.txt || echo "0")
          errors=$(grep -oP 'ì˜¤ë¥˜: \K\d+' sync_log.txt || echo "0")
          echo "updated=$updated" >> $GITHUB_OUTPUT
          echo "created=$created" >> $GITHUB_OUTPUT
          echo "errors=$errors" >> $GITHUB_OUTPUT

      - name: ğŸ“ ë™ê¸°í™” ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: sync-log-${{ github.run_number }}
          path: sync_log.txt
          retention-days: 7

  # ============================================
  # Job 2: Notion â†’ Dashboard ë°ì´í„° ë‚´ë³´ë‚´ê¸°
  # ============================================
  export-to-dashboard:
    runs-on: ubuntu-latest
    name: ğŸ“¤ Notion â†’ Dashboard
    needs: [sync-sheets-to-notion]
    if: |
      always() && 
      (needs.sync-sheets-to-notion.result == 'success' || needs.sync-sheets-to-notion.result == 'skipped') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.sync_type != 'sheets')
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install requests

      - name: ğŸ“Š ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        run: python scripts/export_to_dashboard.py

      - name: ğŸ“ ë°ì´í„° íŒŒì¼ ì»¤ë°‹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -d "data" ]; then
            git add data/
            if git diff --staged --quiet; then
              echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            else
              git commit -m "ğŸ“Š ì˜ˆì‚° ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ ($(date '+%Y-%m-%d %H:%M'))"
              git push
            fi
          fi

      - name: ğŸ”„ notion-config.js ì—…ë°ì´íŠ¸
        run: |
          if [ -f "data/summary.json" ]; then
            # summary.jsonì—ì„œ ê°’ ì¶”ì¶œ
            ALLOCATED=$(jq '.ì´ì˜ˆì‚°' data/summary.json)
            EXECUTED=$(jq '.ì´ì§‘í–‰' data/summary.json)
            REMAINING=$(jq '.ì´ì”ì•¡' data/summary.json)
            RATE=$(jq '.ì§‘í–‰ë¥ ' data/summary.json)
            DAYS=$(jq '.ë‚¨ì€ì¼ìˆ˜' data/summary.json)
            TODAY=$(date '+%Y-%m-%d')
            
            echo "ğŸ“Š ì—…ë°ì´íŠ¸ ê°’:"
            echo "   ë°°ì •ì˜ˆì‚°: $ALLOCATED"
            echo "   ì§‘í–‰ê¸ˆì•¡: $EXECUTED"
            echo "   ì§‘í–‰ë¥ : $RATE%"
            echo "   ë‚¨ì€ì¼ìˆ˜: D-$DAYS"
            
            # notion-config.jsê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            if [ -f "notion-config.js" ]; then
              sed -i "s/updateDate: '[^']*'/updateDate: '$TODAY'/" notion-config.js
              sed -i "s/allocatedBudget: [0-9]*/allocatedBudget: $ALLOCATED/" notion-config.js
              sed -i "s/executedAmount: [0-9]*/executedAmount: $EXECUTED/" notion-config.js
              sed -i "s/executionRate: [0-9.]*,/executionRate: $RATE,/" notion-config.js
              sed -i "s/remainingBudget: [0-9]*/remainingBudget: $REMAINING/" notion-config.js
              sed -i "s/daysRemaining: [0-9]*/daysRemaining: $DAYS/" notion-config.js
              
              git add notion-config.js
              if ! git diff --staged --quiet; then
                git commit -m "ğŸ“ˆ ëŒ€ì‹œë³´ë“œ ì„¤ì • ì—…ë°ì´íŠ¸ ($TODAY)"
                git push
              fi
            fi
          fi

  # ============================================
  # Job 3: ê²°ê³¼ ì•Œë¦¼
  # ============================================
  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¨ ê²°ê³¼ ì•Œë¦¼
    needs: [sync-sheets-to-notion, export-to-dashboard]
    if: always()
    
    steps:
      - name: ğŸ’¬ Slack ì„±ê³µ ì•Œë¦¼
        if: needs.sync-sheets-to-notion.result == 'success' || needs.sync-sheets-to-notion.result == 'skipped'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… ì˜ˆì‚° ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*ì—…ë°ì´íŠ¸:* ${{ needs.sync-sheets-to-notion.outputs.updated || '0' }}ê±´"},
                    {"type": "mrkdwn", "text": "*ì‹ ê·œìƒì„±:* ${{ needs.sync-sheets-to-notion.outputs.created || '0' }}ê±´"},
                    {"type": "mrkdwn", "text": "*íŠ¸ë¦¬ê±°:* ${{ github.event_name }}"},
                    {"type": "mrkdwn", "text": "*ì‹œê°„:* ${{ github.event.head_commit.timestamp || 'N/A' }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ğŸ“Š Notion ë³´ê¸°"},
                      "url": "https://www.notion.so/54bfedc3769e43e8bdbcd59f22008417"
                    },
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ğŸ“ˆ ëŒ€ì‹œë³´ë“œ ë³´ê¸°"},
                      "url": "https://leesungho-ai.github.io/Asan-Smart-City-Budget-Management-System-BMS-/"
                    },
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ğŸ”§ Actions ë¡œê·¸"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: ğŸ’¬ Slack ì‹¤íŒ¨ ì•Œë¦¼
        if: needs.sync-sheets-to-notion.result == 'failure' || needs.export-to-dashboard.result == 'failure'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ ì˜ˆì‚° ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.*\në¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "ğŸ”§ ë¡œê·¸ í™•ì¸"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
