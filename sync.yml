name: ğŸ”„ ì˜ˆì‚° ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™”

on:
  # ë§¤ ì‹œê°„ ìë™ ì‹¤í–‰ (ì‹¤ì‹œê°„ì— ê°€ê¹ê²Œ)
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œ ì •ê°
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
  
  # Slack webhook íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [budget-update, slack-trigger]
  
  # ì½”ë“œ ë³€ê²½ ì‹œ
  push:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸ“Š ë°ì´í„° ë™ê¸°í™” ë° ë°°í¬
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: pip install requests

      - name: ğŸ”„ Notion ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        run: python api/fetch_notion_data.py
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

      - name: ğŸ“ ë°ì´í„° ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "data/budget.json" ]; then
            git add data/budget.json
            if git diff --staged --quiet; then
              echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            else
              git commit -m "ğŸ“Š ì˜ˆì‚° ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d %H:%M KST')"
              git push
            fi
          fi

      - name: ğŸš€ GitHub Pages ë°°í¬
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¦ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ğŸŒ ë°°í¬
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ’¬ Slack ì•Œë¦¼ (ì„±ê³µ)
        if: success() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {"type": "plain_text", "text": "âœ… ì˜ˆì‚° ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ", "emoji": true}
                },
                {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "Notion ë°ì´í„°ê°€ GitHub Pages ëŒ€ì‹œë³´ë“œì— ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n*ì‹œê°„:* '"$(date '+%Y-%m-%d %H:%M KST')"'"}
                },
                {
                  "type": "actions",
                  "elements": [
                    {"type": "button", "text": {"type": "plain_text", "text": "ğŸ“Š ëŒ€ì‹œë³´ë“œ ë³´ê¸°"}, "url": "https://leesungho-ai.github.io/Asan-Smart-City-Budget-Management-System-BMS-/"},
                    {"type": "button", "text": {"type": "plain_text", "text": "ğŸ“‹ Notion ë³´ê¸°"}, "url": "https://www.notion.so/54bfedc3769e43e8bdbcd59f22008417"}
                  ]
                }
              ]
            }'

      - name: ğŸ’¬ Slack ì•Œë¦¼ (ì‹¤íŒ¨)
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {"type": "plain_text", "text": "âŒ ì˜ˆì‚° ëŒ€ì‹œë³´ë“œ ë™ê¸°í™” ì‹¤íŒ¨", "emoji": true}
                },
                {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸>"}
                }
              ]
            }'
